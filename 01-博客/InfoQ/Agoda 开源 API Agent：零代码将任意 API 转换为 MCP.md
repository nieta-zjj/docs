# Agoda 开源 API Agent：零代码将任意 API 转换为 MCP

## 文档信息
- 来源：https://www.infoq.cn/article/lTdPVphiffHFz6prrxu3?utm_source=rss&utm_medium=article

## 摘要
### 1) 一句话总结
Agoda 开源了零代码系统 API Agent，通过动态架构内省与 DuckDB 数据处理，使单个 MCP 服务器能够直接、安全地对接并查询任意 REST 或 GraphQL API。

### 2) 核心要点
*   **零代码与统一管理**：无需为每个 API 单独搭建 MCP 服务器，一次部署即可通过共享实例服务多个 API，新增 API 仅需更新配置。
*   **动态架构内省**：自动解析 GraphQL（提取类型、字段和参数）和 REST API（基于 OpenAPI 规范或 JSON 示例），无需预构建适配器即可构造查询。
*   **核心技术栈**：底层采用 FastMCP（构建服务器）、OpenAI Agents SDK（LLM 编排）以及 DuckDB（内存 SQL 后处理）。
*   **突破上下文限制**：利用 DuckDB 作为 SQL 上下文管理层，对庞大的 API 响应进行存储、过滤与聚合，仅将精简后的结果发送给大模型。
*   **安全与权限控制**：系统默认开启安全机制并以**只读模式**运行，仅在明确启用并加入白名单后才允许执行修改操作。
*   **性能与查询优化**：支持将重复查询转化为参数化的“Recipe”以缩短延迟；提供“直接返回”选项跳过 LLM 摘要；支持单会话跨端点复杂关联查询。
*   **可观测性**：集成了 OpenTelemetry、Jaeger、Zipkin、Grafana Tempo 和 Arize Phoenix 等工具以实现完善的系统监控。

### 3) 风险与缺口
*   **上下文截断风险**：API 响应往往包含数千行数据，极易超出大语言模型的上下文长度限制导致内容被截断（系统通过引入 DuckDB 解决此痛点）。
*   **任意代码执行风险**：在 AI 辅助数据转换与后处理过程中存在执行恶意代码的风险（系统通过采用声明式的 SQL 后处理规避了此风险及相关的沙箱、网络隔离问题）。

## 正文
Agoda 工程师近期开发并开源了一款名为 API Agent 的系统。这是一个零代码、零部署的解决方案，能够让单个模型上下文协议（MCP）服务器直接对接内部的 REST 或 GraphQL API。

过去，为了让 AI 助手查询相关服务，团队需要为每个 API 单独搭建 MCP 服务器，管理多种架构和认证方式带来了高昂的运维成本。Agoda 首席技术官 Idan Zalzberg 表示，许多团队都希望将内部工具开放给 AI 使用，但逐一编写 MCP 工作量极大。API Agent 采用的创新零代码方案，在业内属于首创。

### 核心机制：动态架构内省

API Agent 可作为通用的 MCP 服务器使用。工程师只需在 MCP 客户端中配置目标 URL 与 API 类型，智能体便能自动对 API 架构进行自省，并根据自然语言输入生成查询。

*   **动态检索**：对于 GraphQL，它会提取类型、字段和输入参数；对于 REST API，它会基于 OpenAPI 规范或 JSON 响应示例进行解析。这使得智能体无需预构建适配器即可自动构造查询。
*   **一次部署，多方服务**：一次部署即可同时服务多个 API。每个 API 在客户端看来都是独立的 MCP 服务器，但实际上共享同一个实例。新增 API 仅需更新配置即可。

### 技术栈与丰富特性

系统的底层技术栈包括：
*   **FastMCP**：用于构建 MCP 服务器。
*   **OpenAI Agents SDK**：用于大语言模型（LLM）的编排。
*   **DuckDB**：用于内存 SQL 后处理。

此外，系统还具备动态工具命名、大型 API 的 Schema 搜索、多步骤查询的会话跟踪等功能，并通过 OpenTelemetry、Jaeger、Zipkin、Grafana Tempo 或 Arize Phoenix 实现了完善的可观测能力。

### 引入 DuckDB 突破上下文限制

API 的响应往往包含数千行数据，极易超出大语言模型的上下文长度限制导致内容被截断。为了解决这一痛点，API Agent 引入了 DuckDB，将 SQL 作为上下文管理层：

*   完整的 API 响应会被存储、过滤与聚合，系统只将精简后的结果发送给模型。
*   DuckDB 可在进程内运行，原生支持 JSON 并能自动推断 Schema。
*   使用 SQL 进行后处理，既避免了任意代码执行的风险，又能保持与 LLM 查询生成的良好兼容性。

### 安全模型与运维经验

在安全性方面，API Agent 默认开启安全机制，以**只读模式**运行。除非明确启用并加入内部工具白名单，否则系统不允许执行任何修改操作。

基于实际的运维经验，Agoda 团队总结了以下优化与实践：

*   **错误与提示**：在响应被截断时进行清晰提示；暴露完整错误信息以便 LLM 进行自行修正。
*   **数据处理**：优先使用 Schema 而非样本数据；妥善处理 SQL 特性相关问题。
*   **性能优化**：重复查询会被转化为参数化的“Recipe”，从而缩短推理耗时与延迟；提供“直接返回”选项，让过滤后的数据跳过 LLM 摘要步骤。
*   **高级查询**：支持在单个会话中跨多个端点查询，完成复杂的关联与聚合操作。

基于 SQL 的后处理规避了沙箱、网络隔离和依赖问题，其声明式风格与大语言模型高度适配，实现了安全的 AI 辅助数据转换。目前，该项目已开源（项目名为 `api-agent`），开发者可用于 REST 和 GraphQL 的相关实验。
